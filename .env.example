# 复制为 .env 并填入真实值（不要提交到仓库）
# ChatModel（上游 OpenAI 兼容服务）的 Key（例如 DeepSeek / OpenAI 等 OpenAI-Compatible 服务）
CHAT_API_KEY=replace-me

# ========== Chat（对话模型，上游 OpenAI 兼容）==========
# DeepSeek 示例：
# CHAT_BASE_URL=https://api.deepseek.com/v1
# CHAT_MODEL=deepseek-chat
CHAT_BASE_URL=https://api.openai.com/v1
CHAT_MODEL=gpt-4o-mini
CHAT_PROVIDER=langchain
CHAT_MODEL_PROVIDER=openai
CHAT_TIMEOUT_S=60
CHAT_MAX_RETRIES=2

# 默认生成参数（客户端未传时使用）
CHAT_DEFAULT_TEMPERATURE=0.2
CHAT_DEFAULT_TOP_P=1
CHAT_DEFAULT_MAX_TOKENS=1024

# 多模型路由（可选）
# 说明：外部请求的 model -> 上游模型名；不配置则统一使用 CHAT_MODEL
# 示例（DeepSeek）：
# CHAT_MODEL_MAP_JSON={"onekey-docs":"deepseek-chat","onekey-docs-reason":"deepseek-reasoner"}
# 当客户端直接传上游模型名时是否允许透传（不在 map 中则回退到 CHAT_MODEL）
CHAT_MODEL_PASSTHROUGH=false

# ========== 多轮对话：Query rewrite / 记忆压缩 ==========
QUERY_REWRITE_ENABLED=true
MEMORY_SUMMARY_ENABLED=true
CONVERSATION_COMPACTION_MAX_TOKENS=384
CONVERSATION_HISTORY_MAX_MESSAGES=12
CONVERSATION_HISTORY_MAX_CHARS=6000

# ========== 引用格式 ==========
# 启用 inline citation（如 [1][2]），更接近 Inkeep 体验；sources 中会带 ref 编号
INLINE_CITATIONS_ENABLED=true
# 是否在 content 末尾追加“参考/来源”列表（UI 若已展示 sources，一般可关闭）
ANSWER_APPEND_SOURCES=false

# ========== 任务队列（抓取/索引）==========
# background：FastAPI BackgroundTasks（进程内，不可恢复，可能影响对话延迟）
# worker：使用 jobs 表做持久化队列，由独立 Worker 容器消费（推荐）
JOBS_BACKEND=worker
# Worker 参数（仅当启用 worker 时生效）
WORKER_POLL_INTERVAL_S=1
WORKER_STALE_AFTER_S=3600
WORKER_MAX_ATTEMPTS=3

# pgvector 向量维度（需与 Embedding 模型输出一致）
PGVECTOR_EMBEDDING_DIM=768

# ========== Embeddings（向量化）==========
# 可选：fake（仅用于链路跑通）、sentence_transformers（本地模型）、ollama（本地 Ollama）、openai_compatible（上游 OpenAI 兼容 embedding）
EMBEDDINGS_PROVIDER=sentence_transformers

# 本地 sentence-transformers Embedding（推荐）
# 说明：首次运行会自动下载模型到 HuggingFace 缓存；生产建议把模型文件预下载/挂载到容器内路径。
SENTENCE_TRANSFORMERS_MODEL=sentence-transformers/paraphrase-multilingual-mpnet-base-v2

# （可选）本地 Ollama Embedding（如需）
# OLLAMA_BASE_URL=http://host.docker.internal:11434
# OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# （可选）使用本地磁盘模型（避免在线下载）
# SENTENCE_TRANSFORMERS_MODEL=/models/your-embedding-model

# ========== Rerank（可选：重排）==========
# 说明：对标 Inkeep 的引用质量，建议开启本地 cross-encoder 重排（bge-reranker）。
# 取值：none / bge_reranker
RERANK_PROVIDER=bge_reranker
BGE_RERANKER_MODEL=BAAI/bge-reranker-large
RERANK_DEVICE=cpu
RERANK_BATCH_SIZE=16
RERANK_MAX_CANDIDATES=30
RERANK_MAX_CHARS=1200

# ========== RAG（检索/上下文组装）==========
RETRIEVAL_MODE=hybrid
HYBRID_VECTOR_K=30
HYBRID_BM25_K=30
HYBRID_VECTOR_WEIGHT=0.7
HYBRID_BM25_WEIGHT=0.3
BM25_FTS_CONFIG=simple

# 启动时自动创建索引（MVP 默认开启；数据规模很大时可关闭并改为手动建索引）
AUTO_CREATE_INDEXES=true
PGVECTOR_INDEX_TYPE=hnsw
PGVECTOR_HNSW_M=16
PGVECTOR_HNSW_EF_CONSTRUCTION=64
PGVECTOR_IVFFLAT_LISTS=100

RAG_TOP_K=30
RAG_TOP_N=8
RAG_MAX_SOURCES=3
RAG_CONTEXT_MAX_CHARS=12000
RAG_SNIPPET_MAX_CHARS=360
# RAG 超时保护（避免“长时间无响应”）
RAG_PREPARE_TIMEOUT_S=25
RAG_TOTAL_TIMEOUT_S=120
# 并发控制（对话请求的并发上限）
MAX_CONCURRENT_CHAT_REQUESTS=12
# Query embedding 缓存（提升重复问答的性能）
QUERY_EMBED_CACHE_SIZE=512
QUERY_EMBED_CACHE_TTL_S=600

# ========== Chunking（分块）==========
CHUNK_MAX_CHARS=2400
CHUNK_OVERLAP_CHARS=200

# ========== Widget（前端 iframe）==========
# 允许哪些父页面通过 iframe 嵌入 /widget（CSP: frame-ancestors）。
# 生产建议配置为："'self' https://developer.onekey.so"（建议整体用双引号包住，内部保留 `'self'`）
# 示例：WIDGET_FRAME_ANCESTORS="'self' https://developer.onekey.so"
# 为空表示不下发该 CSP（允许所有父页面嵌入）。
WIDGET_FRAME_ANCESTORS=

# ========== Admin（企业后台）==========
# Admin UI：/admin/ui/（同域静态站点，使用 JWT 访问 /admin/api/*）
ADMIN_USERNAME=admin
# 生产必须设置强密码
ADMIN_PASSWORD=replace-me
# 生产必须设置强随机密钥（用于签发/校验 JWT）
ADMIN_JWT_SECRET=replace-me
# access_token 过期时间（秒）
ADMIN_JWT_EXPIRES_S=3600

# ========== Observability（仅存检索调试元数据，不存原文）==========
RETRIEVAL_EVENTS_ENABLED=true

# ========== Langfuse（v3，需要 Postgres + ClickHouse + Redis）==========
LANGFUSE_VERSION=3.132.0
LANGFUSE_BASE_URL=http://localhost:3000
LANGFUSE_DATABASE_URL=postgresql://postgres:replace-me@postgres:5432/langfuse
LANGFUSE_REDIS_URL=redis://langfuse-redis:6379/0

# ClickHouse：默认无密码；若设密码，请同步修改两个 URL
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=replace-me
CLICKHOUSE_URL=http://default:replace-me@clickhouse:8123/langfuse
CLICKHOUSE_MIGRATION_URL=clickhouse://default:replace-me@clickhouse:9000/langfuse

LANGFUSE_PUBLIC_KEY=replace-me
LANGFUSE_SECRET_KEY=replace-me
LANGFUSE_SECRET_KEY_BASE=replace-me
LANGFUSE_API_KEY=replace-me
LANGFUSE_NEXTAUTH_SECRET=replace-me
NEXTAUTH_URL=http://localhost:3000
SALT=replace-me
NEXT_PUBLIC_LANGFUSE_RUN_NEXT_INIT=false

LANGFUSE_SEARCH_BACKEND=none
LANGFUSE_MSEARCH_URL=
LANGFUSE_STORAGE_BACKEND=
LANGFUSE_STORAGE_ENDPOINT=
LANGFUSE_STORAGE_ACCESS_KEY_ID=
LANGFUSE_STORAGE_SECRET_ACCESS_KEY=
LANGFUSE_S3_EVENT_UPLOAD_BUCKET=local

LANGFUSE_PROJECT_NAME=onekey-rag
LANGFUSE_DATASET_NAME=rag-llm

# ========== 应用运行参数 ==========
APP_ENV=local
LOG_LEVEL=INFO

DATABASE_URL=postgresql+psycopg2://postgres:replace-me@postgres:5432/onekey_rag
CRAWL_BASE_URL=https://developer.onekey.so/
CRAWL_SITEMAP_URL=https://developer.onekey.so/sitemap.xml
CRAWL_MAX_PAGES=2000
