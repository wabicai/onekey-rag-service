services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-replace-me}
      POSTGRES_DB: onekey_rag
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./deploy/init-langfuse.sql:/docker-entrypoint-initdb.d/init-langfuse.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d onekey_rag"]
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      APP_ENV: ${APP_ENV:-local}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:replace-me@postgres:5432/onekey_rag}
      PGVECTOR_EMBEDDING_DIM: ${PGVECTOR_EMBEDDING_DIM:-768}
      JOBS_BACKEND: ${JOBS_BACKEND:-worker}

      CRAWL_BASE_URL: ${CRAWL_BASE_URL:-https://developer.onekey.so/}
      CRAWL_SITEMAP_URL: ${CRAWL_SITEMAP_URL:-https://developer.onekey.so/sitemap.xml}
      CRAWL_MAX_PAGES: ${CRAWL_MAX_PAGES:-2000}

      # Embeddings（默认 fake 仅跑通链路；推荐改成 sentence_transformers）
      EMBEDDINGS_PROVIDER: ${EMBEDDINGS_PROVIDER:-fake}
      SENTENCE_TRANSFORMERS_MODEL: ${SENTENCE_TRANSFORMERS_MODEL:-}
      # Docker 容器访问宿主机 Ollama：Mac/Windows 用 host.docker.internal；Linux 需额外配置 host-gateway
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}

      # Rerank（可选）
      RERANK_PROVIDER: ${RERANK_PROVIDER:-none}
      BGE_RERANKER_MODEL: ${BGE_RERANKER_MODEL:-BAAI/bge-reranker-large}
      RERANK_DEVICE: ${RERANK_DEVICE:-cpu}
      RERANK_BATCH_SIZE: ${RERANK_BATCH_SIZE:-16}
      RERANK_MAX_CANDIDATES: ${RERANK_MAX_CANDIDATES:-30}
      RERANK_MAX_CHARS: ${RERANK_MAX_CHARS:-1200}

      CHAT_PROVIDER: ${CHAT_PROVIDER:-langchain}
      CHAT_MODEL_PROVIDER: ${CHAT_MODEL_PROVIDER:-openai}
      CHAT_BASE_URL: ${CHAT_BASE_URL:-https://api.openai.com/v1}
      CHAT_MODEL: ${CHAT_MODEL:-gpt-4o-mini}
      CHAT_TIMEOUT_S: ${CHAT_TIMEOUT_S:-60}
      CHAT_MAX_RETRIES: ${CHAT_MAX_RETRIES:-2}

      # 多轮对话：Query rewrite / 记忆压缩
      QUERY_REWRITE_ENABLED: ${QUERY_REWRITE_ENABLED:-true}
      MEMORY_SUMMARY_ENABLED: ${MEMORY_SUMMARY_ENABLED:-true}
      CONVERSATION_COMPACTION_MAX_TOKENS: ${CONVERSATION_COMPACTION_MAX_TOKENS:-384}
      CONVERSATION_HISTORY_MAX_MESSAGES: ${CONVERSATION_HISTORY_MAX_MESSAGES:-12}
      CONVERSATION_HISTORY_MAX_CHARS: ${CONVERSATION_HISTORY_MAX_CHARS:-6000}

      # 引用格式：inline citation + sources(ref)
      INLINE_CITATIONS_ENABLED: ${INLINE_CITATIONS_ENABLED:-true}
      ANSWER_APPEND_SOURCES: ${ANSWER_APPEND_SOURCES:-false}
      RAG_PREPARE_TIMEOUT_S: ${RAG_PREPARE_TIMEOUT_S:-25}
      RAG_TOTAL_TIMEOUT_S: ${RAG_TOTAL_TIMEOUT_S:-120}

      # Widget（iframe）安全：CSP frame-ancestors（为空表示不设置）
      WIDGET_FRAME_ANCESTORS: ${WIDGET_FRAME_ANCESTORS:-}

      # 检索（默认 hybrid：BM25+向量）
      RETRIEVAL_MODE: ${RETRIEVAL_MODE:-hybrid}
      BM25_FTS_CONFIG: ${BM25_FTS_CONFIG:-simple}
      HYBRID_VECTOR_K: ${HYBRID_VECTOR_K:-30}
      HYBRID_BM25_K: ${HYBRID_BM25_K:-30}
      HYBRID_VECTOR_WEIGHT: ${HYBRID_VECTOR_WEIGHT:-0.7}
      HYBRID_BM25_WEIGHT: ${HYBRID_BM25_WEIGHT:-0.3}

      # 索引（MVP 默认自动创建）
      AUTO_CREATE_INDEXES: ${AUTO_CREATE_INDEXES:-true}
      PGVECTOR_INDEX_TYPE: ${PGVECTOR_INDEX_TYPE:-hnsw}
      PGVECTOR_HNSW_M: ${PGVECTOR_HNSW_M:-16}
      PGVECTOR_HNSW_EF_CONSTRUCTION: ${PGVECTOR_HNSW_EF_CONSTRUCTION:-64}
      PGVECTOR_IVFFLAT_LISTS: ${PGVECTOR_IVFFLAT_LISTS:-100}
      # CHAT_API_KEY: 请放到 .env 文件里（不要提交到仓库）
    env_file:
      - .env
    volumes:
      # 缓存 HuggingFace 模型下载（sentence-transformers/transformers）
      - hf_cache:/root/.cache/huggingface
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "onekey_rag_service.worker"]
    environment:
      APP_ENV: ${APP_ENV:-local}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:replace-me@postgres:5432/onekey_rag}
      PGVECTOR_EMBEDDING_DIM: ${PGVECTOR_EMBEDDING_DIM:-768}
      JOBS_BACKEND: ${JOBS_BACKEND:-worker}

      CRAWL_BASE_URL: ${CRAWL_BASE_URL:-https://developer.onekey.so/}
      CRAWL_SITEMAP_URL: ${CRAWL_SITEMAP_URL:-https://developer.onekey.so/sitemap.xml}
      CRAWL_MAX_PAGES: ${CRAWL_MAX_PAGES:-2000}

      # Embeddings（默认 fake 仅跑通链路；推荐改成 sentence_transformers）
      EMBEDDINGS_PROVIDER: ${EMBEDDINGS_PROVIDER:-fake}
      SENTENCE_TRANSFORMERS_MODEL: ${SENTENCE_TRANSFORMERS_MODEL:-}
      # Docker 容器访问宿主机 Ollama：Mac/Windows 用 host.docker.internal；Linux 需额外配置 host-gateway
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}

      # Rerank（可选）
      RERANK_PROVIDER: ${RERANK_PROVIDER:-none}
      BGE_RERANKER_MODEL: ${BGE_RERANKER_MODEL:-BAAI/bge-reranker-large}
      RERANK_DEVICE: ${RERANK_DEVICE:-cpu}
      RERANK_BATCH_SIZE: ${RERANK_BATCH_SIZE:-16}
      RERANK_MAX_CANDIDATES: ${RERANK_MAX_CANDIDATES:-30}
      RERANK_MAX_CHARS: ${RERANK_MAX_CHARS:-1200}

      # 索引（MVP 默认自动创建）
      AUTO_CREATE_INDEXES: ${AUTO_CREATE_INDEXES:-true}
      PGVECTOR_INDEX_TYPE: ${PGVECTOR_INDEX_TYPE:-hnsw}
      PGVECTOR_HNSW_M: ${PGVECTOR_HNSW_M:-16}
      PGVECTOR_HNSW_EF_CONSTRUCTION: ${PGVECTOR_HNSW_EF_CONSTRUCTION:-64}
      PGVECTOR_IVFFLAT_LISTS: ${PGVECTOR_IVFFLAT_LISTS:-100}

      # Worker 参数
      WORKER_POLL_INTERVAL_S: ${WORKER_POLL_INTERVAL_S:-1}
      WORKER_STALE_AFTER_S: ${WORKER_STALE_AFTER_S:-3600}
      WORKER_MAX_ATTEMPTS: ${WORKER_MAX_ATTEMPTS:-3}
    env_file:
      - .env
    volumes:
      - hf_cache:/root/.cache/huggingface
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy

  langfuse:
    image: langfuse/langfuse:${LANGFUSE_VERSION:-latest}
    env_file:
      - .env
    environment:
      DATABASE_URL: ${LANGFUSE_DATABASE_URL:-postgresql://postgres:replace-me@postgres:5432/langfuse}
      REDIS_URL: ${LANGFUSE_REDIS_URL:-redis://langfuse-redis:6379/0}
      CLICKHOUSE_URL: ${CLICKHOUSE_URL:-http://default:replace-me@clickhouse:8123/langfuse}
      CLICKHOUSE_MIGRATION_URL: ${CLICKHOUSE_MIGRATION_URL:-clickhouse://default:replace-me@clickhouse:9000/langfuse}
      SECRET_KEY_BASE: ${LANGFUSE_SECRET_KEY_BASE:-changeme}
      LANGFUSE_API_KEY: ${LANGFUSE_API_KEY:-changeme}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      NEXTAUTH_SECRET: ${LANGFUSE_NEXTAUTH_SECRET:-changeme}
      NEXT_PUBLIC_LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL:-http://localhost:3000}
      SEARCH_BACKEND: ${LANGFUSE_SEARCH_BACKEND:-none}
      MSEARCH_URL: ${LANGFUSE_MSEARCH_URL:-}
      STORAGE_BACKEND: ${LANGFUSE_STORAGE_BACKEND:-}
      STORAGE_ENDPOINT: ${LANGFUSE_STORAGE_ENDPOINT:-}
      STORAGE_ACCESS_KEY_ID: ${LANGFUSE_STORAGE_ACCESS_KEY_ID:-}
      STORAGE_SECRET_ACCESS_KEY: ${LANGFUSE_STORAGE_SECRET_ACCESS_KEY:-}
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      langfuse-redis:
        condition: service_started
      clickhouse:
        condition: service_healthy
    restart: unless-stopped

  langfuse-redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - langfuse-redis:/data
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    environment:
      CLICKHOUSE_DB: langfuse
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-replace-me}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./deploy/clickhouse/remote_servers.xml:/etc/clickhouse-server/config.d/remote_servers.xml:ro
      - ./deploy/clickhouse/keeper.xml:/etc/clickhouse-server/config.d/keeper.xml:ro
      - ./deploy/clickhouse/macros.xml:/etc/clickhouse-server/config.d/macros.xml:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  frontend:
    image: node:20-alpine
    working_dir: /app
    command: ["sh", "-c", "yarn install --frozen-lockfile && yarn dev"]
    environment:
      VITE_API_PROXY_TARGET: http://api:8000
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    depends_on:
      api:
        condition: service_started

  frontend-admin:
    image: node:20-alpine
    working_dir: /app
    command: ["sh", "-c", "yarn install --frozen-lockfile && yarn dev"]
    environment:
      VITE_ADMIN_API_PROXY_TARGET: http://api:8000
    volumes:
      - ./frontend-admin:/app
      - frontend-admin-node-modules:/app/node_modules
    depends_on:
      api:
        condition: service_started

  caddy:
    image: caddy:2-alpine
    ports:
      - "8000:8000"
    volumes:
      - ./deploy/Caddyfile.dev:/etc/caddy/Caddyfile:ro
    depends_on:
      api:
        condition: service_started
      frontend-admin:
        condition: service_started

volumes:
  pgdata:
  hf_cache:
  langfuse-redis:
  clickhouse-data:
  frontend-node-modules:
  frontend-admin-node-modules:
